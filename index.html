<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance Monitoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">Sistem Kehadiran Pelajar 2025/2026</h1>
            <p class="text-center text-gray-500 mt-2">Pemantauan Kehadiran Pelajar Sesi 2025/2026</p>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-entry" class="px-3 py-2 font-medium text-sm rounded-t-md tab-active">Catat Kehadiran</button>
                <button id="tab-dashboard" class="px-3 py-2 font-medium text-sm rounded-t-md text-gray-500 hover:text-gray-700">Papar Kehadiran</button>
                <button id="tab-summary" class="px-3 py-2 font-medium text-sm rounded-t-md text-gray-500 hover:text-gray-700">Ringkasan Kelas</button>
            </nav>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Attendance Entry Section -->
            <div id="content-entry">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700">Daftar Kehadiran</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label for="entry-date" class="block text-sm font-medium text-gray-600 mb-1">Tarikh</label>
                            <input type="date" id="entry-date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="entry-time" class="block text-sm font-medium text-gray-600 mb-1">Masa</label>
                            <input type="time" id="entry-time" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="entry-class" class="block text-sm font-medium text-gray-600 mb-1">Nama Kelas</label>
                            <select id="entry-class" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="entry-class-type" class="block text-sm font-medium text-gray-600 mb-1">Mod Kelas</label>
                            <select id="entry-class-type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Holiday/Remark Section -->
                    <div class="mt-6 border-t pt-4">
                        <div class="flex items-center">
                            <input id="session-remark-toggle" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="session-remark-toggle" class="ml-2 block text-sm font-medium text-gray-700">Tandakan sesi ini sebagai Cuti Umum atau Acara Khas (tiada kehadiran diambil)</label>
                        </div>
                        <div id="session-remark-container" class="hidden mt-4">
                            <label for="session-remark-input" class="block text-sm font-medium text-gray-600 mb-1">Sebab / Catatan</label>
                            <input type="text" id="session-remark-input" placeholder="Cth: Cuti Hari Kemerdekaan, Kelas Batal" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <h3 id="student-list-header" class="text-lg font-semibold text-gray-700 my-4 border-t pt-4">Senarai Pelajar</h3>
                    <div id="student-list" class="space-y-4">
                        <!-- Student rows will be populated by JS -->
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button id="submit-attendance" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                            Catat Kehadiran
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="content-dashboard" class="hidden">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700">Data Kehadiran Pelajar</h2>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                         <div>
                             <label for="dashboard-class" class="block text-sm font-medium text-gray-600 mb-1">Pilih Kelas</label>
                             <select id="dashboard-class" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                 <!-- Options will be populated by JS -->
                             </select>
                         </div>
                         <div>
                            <label for="dashboard-class-type" class="block text-sm font-medium text-gray-600 mb-1">Pilih Mod Kelas</label>
                            <select id="dashboard-class-type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="dashboard-month" class="block text-sm font-medium text-gray-600 mb-1">Pilih Bulan</label>
                            <select id="dashboard-month" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                     </div>

                     <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pelajar</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% Kehadiran</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ketidakhadiran</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-body" class="bg-white divide-y divide-gray-200">
                                <!-- Dashboard rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- Summary Section -->
            <div id="content-summary" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700">Ringkasan Kehadiran Keseluruhan</h2>
                    <div class="mb-6">
                        <label for="summary-month" class="block text-sm font-medium text-gray-600 mb-1">Tapis Mengikut Bulan</label>
                        <select id="summary-month" class="w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Kelas</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah Kelas Dijalankan</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Kehadiran Keseluruhan (%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kehadiran Tertinggi</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kehadiran Terendah</th>
                                </tr>
                            </thead>
                            <tbody id="summary-body" class="bg-white divide-y divide-gray-200">
                                <!-- Summary rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Remarks Modal -->
    <div id="remarks-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" id="modal-student-name"></h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-remarks-content" class="text-sm text-gray-600 space-y-2 max-h-60 overflow-y-auto">
                <!-- Remarks will be populated here -->
            </div>
        </div>
    </div>

    <!-- Sessions Modal -->
    <div id="sessions-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:max-w-lg mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800" id="sessions-modal-title"></h3>
                <button id="close-sessions-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="sessions-modal-content" class="text-sm text-gray-600 space-y-2 max-h-60 overflow-y-auto">
                <!-- Session list will be populated here -->
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:max-w-md mx-auto p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Sahkan Padam</h3>
            <p id="delete-confirm-message" class="text-gray-600 mb-6">Adakah anda pasti mahu memadam rekod kehadiran ini? Tindakan ini tidak boleh diubah.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Batal</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700">Padam</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert -->
    <div id="custom-alert" class="fixed top-5 right-5 z-50 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hidden transition-transform translate-x-full">
        <p id="alert-message"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // --- CONFIGURATION ---
                // ** TAMPAL (PASTE) PAUTAN GOOGLE SHEET ANDA DI SINI **
                googleSheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRlfpghvp8zv38Kj6EpVEeQzALCIh71ZrmH2WwxlhcOEo1C16I_xXP1Fvqruu6p_qPvlPw37TWYlbzy/pub?output=csv',

                // --- DATA ---
                classTypes: ['Practical', 'Tutorial'],
                classRosters: {}, 
                attendanceData: {}, 

                // --- INITIALIZATION ---
                async init() {
                    this.cacheDOM();
                    await this.loadRostersFromGoogleSheet();
                    this.loadData();
                    this.bindEvents();
                    this.render();
                    this.setInitialDateTime();
                },
                
                async loadRostersFromGoogleSheet() {
                    if (!this.googleSheetUrl || this.googleSheetUrl === 'PASTE_YOUR_GOOGLE_SHEET_CSV_URL_HERE') {
                        this.showAlert('Pautan Google Sheet tidak ditetapkan. Menggunakan data contoh.', 'error');
                        this.classRosters = {
                            'Contoh Kelas A': ['Pelajar Contoh 1', 'Pelajar Contoh 2'],
                            'Contoh Kelas B': ['Pelajar Contoh 3', 'Pelajar Contoh 4']
                        };
                        return;
                    }

                    try {
                        const response = await fetch(this.googleSheetUrl);
                        if (!response.ok) {
                            throw new Error(`Ralat rangkaian: ${response.statusText}`);
                        }
                        const csvText = await response.text();
                        const rosters = {};
                        const rows = csvText.split('\n').filter(row => row.trim() !== '').slice(1); 

                        rows.forEach(row => {
                            const parts = row.split(',');
                            const className = parts[0]?.trim();
                            const studentName = parts.slice(1).join(',')?.trim().replace(/"/g, '');

                            if (className && studentName) {
                                if (!rosters[className]) {
                                    rosters[className] = [];
                                }
                                rosters[className].push(studentName);
                            }
                        });

                        this.classRosters = rosters;
                        if (Object.keys(this.classRosters).length === 0) {
                            this.showAlert('Gagal memuatkan senarai pelajar. Semak format/pautan Google Sheet.', 'error');
                        } else {
                            this.showAlert('Senarai pelajar berjaya dimuatkan dari Google Sheet!', 'success');
                        }
                    } catch (error) {
                        console.error('Ralat memuatkan senarai nama:', error);
                        this.showAlert('Gagal memuatkan senarai dari Google Sheet. Menggunakan data contoh.', 'error');
                        this.classRosters = {
                            'Contoh Kelas A': ['Pelajar Contoh 1', 'Pelajar Contoh 2'],
                            'Contoh Kelas B': ['Pelajar Contoh 3', 'Pelajar Contoh 4']
                        };
                    }
                },


                cacheDOM() {
                    this.tabs = { 
                        entry: document.getElementById('tab-entry'), 
                        dashboard: document.getElementById('tab-dashboard'),
                        summary: document.getElementById('tab-summary')
                    };
                    this.content = { 
                        entry: document.getElementById('content-entry'), 
                        dashboard: document.getElementById('content-dashboard'),
                        summary: document.getElementById('content-summary')
                    };
                    this.entryForm = { 
                        date: document.getElementById('entry-date'), 
                        time: document.getElementById('entry-time'), 
                        class: document.getElementById('entry-class'), 
                        classType: document.getElementById('entry-class-type'), 
                        studentList: document.getElementById('student-list'), 
                        submitBtn: document.getElementById('submit-attendance'),
                        studentListHeader: document.getElementById('student-list-header'),
                        sessionRemarkToggle: document.getElementById('session-remark-toggle'),
                        sessionRemarkContainer: document.getElementById('session-remark-container'),
                        sessionRemarkInput: document.getElementById('session-remark-input')
                    };
                    this.dashboardView = { classSelect: document.getElementById('dashboard-class'), classTypeSelect: document.getElementById('dashboard-class-type'), monthSelect: document.getElementById('dashboard-month'), body: document.getElementById('dashboard-body') };
                    this.summaryView = { monthSelect: document.getElementById('summary-month'), body: document.getElementById('summary-body') };
                    this.modal = { container: document.getElementById('remarks-modal'), studentName: document.getElementById('modal-student-name'), content: document.getElementById('modal-remarks-content'), closeBtn: document.getElementById('close-modal') };
                    this.sessionsModal = { container: document.getElementById('sessions-modal'), title: document.getElementById('sessions-modal-title'), content: document.getElementById('sessions-modal-content'), closeBtn: document.getElementById('close-sessions-modal') };
                    this.deleteConfirmModal = { container: document.getElementById('delete-confirm-modal'), message: document.getElementById('delete-confirm-message'), confirmBtn: document.getElementById('confirm-delete-btn'), cancelBtn: document.getElementById('cancel-delete-btn') };
                    this.alert = { container: document.getElementById('custom-alert'), message: document.getElementById('alert-message') };
                },
                
                bindEvents() {
                    this.tabs.entry.addEventListener('click', () => this.switchTab('entry'));
                    this.tabs.dashboard.addEventListener('click', () => this.switchTab('dashboard'));
                    this.tabs.summary.addEventListener('click', () => this.switchTab('summary'));
                    this.entryForm.submitBtn.addEventListener('click', this.submitAttendance.bind(this));
                    this.entryForm.class.addEventListener('change', this.renderStudentEntryList.bind(this));
                    this.entryForm.sessionRemarkToggle.addEventListener('change', this.toggleSessionRemark.bind(this));
                    this.dashboardView.classSelect.addEventListener('change', this.renderDashboard.bind(this));
                    this.dashboardView.classTypeSelect.addEventListener('change', this.renderDashboard.bind(this));
                    this.dashboardView.monthSelect.addEventListener('change', this.renderDashboard.bind(this));
                    this.summaryView.monthSelect.addEventListener('change', this.renderSummary.bind(this));
                    this.modal.closeBtn.addEventListener('click', this.closeModal.bind(this));
                    this.modal.container.addEventListener('click', (e) => { if (e.target === this.modal.container) this.closeModal(); });
                    this.sessionsModal.closeBtn.addEventListener('click', this.closeSessionsModal.bind(this));
                    this.sessionsModal.container.addEventListener('click', (e) => { if (e.target === this.sessionsModal.container) this.closeSessionsModal(); });
                    this.deleteConfirmModal.cancelBtn.addEventListener('click', this.closeDeleteConfirmModal.bind(this));
                    this.deleteConfirmModal.confirmBtn.addEventListener('click', this.executeDeleteSession.bind(this));
                },

                // --- DATA PERSISTENCE (localStorage) ---
                saveData() {
                    localStorage.setItem('attendanceData', JSON.stringify(this.attendanceData));
                },

                loadData() {
                    const data = localStorage.getItem('attendanceData');
                    this.attendanceData = data ? JSON.parse(data) : {};
                },

                // --- RENDER FUNCTIONS ---
                render() {
                    this.populateClassSelects();
                    this.populateClassTypeSelects();
                    this.populateMonthFilters();
                    this.renderStudentEntryList();
                    this.renderDashboard();
                    this.renderSummary();
                },

                populateClassSelects() {
                    const classNames = Object.keys(this.classRosters);
                    if (classNames.length === 0) {
                        const defaultOption = '<option>Tiada kelas dimuatkan</option>';
                        this.entryForm.class.innerHTML = defaultOption;
                        this.dashboardView.classSelect.innerHTML = defaultOption;
                        return;
                    }
                    const classOptions = classNames.map(c => `<option value="${c}">${c}</option>`).join('');
                    this.entryForm.class.innerHTML = classOptions;
                    this.dashboardView.classSelect.innerHTML = classOptions;
                },
                
                populateClassTypeSelects() {
                    const classTypeOptions = this.classTypes.map(c => `<option value="${c}">${c}</option>`).join('');
                    this.entryForm.classType.innerHTML = classTypeOptions;
                    this.dashboardView.classTypeSelect.innerHTML = classTypeOptions;
                },

                populateMonthFilters() {
                    const allDates = new Set();
                    Object.values(this.attendanceData).forEach(classData => {
                        Object.values(classData).forEach(typeData => {
                            typeData.forEach(record => {
                                allDates.add(record.date.substring(0, 7)); // YYYY-MM
                            });
                        });
                    });

                    const sortedMonths = Array.from(allDates).sort().reverse();

                    const monthOptions = sortedMonths.map(month => {
                        const date = new Date(month + '-02'); // Day 2 to avoid timezone issues
                        const monthName = date.toLocaleString('ms-MY', { month: 'long', year: 'numeric' });
                        return `<option value="${month}">${monthName}</option>`;
                    }).join('');

                    const finalOptions = `<option value="all">Semua Bulan</option>` + monthOptions;
                    this.dashboardView.monthSelect.innerHTML = finalOptions;
                    this.summaryView.monthSelect.innerHTML = finalOptions;
                },

                renderStudentEntryList() {
                    const selectedClass = this.entryForm.class.value;
                    const students = this.classRosters[selectedClass] || [];
                    
                    if(students.length === 0) {
                        this.entryForm.studentList.innerHTML = `<p class="text-center text-gray-500">Tiada pelajar dijumpai untuk kelas ini.</p>`;
                        return;
                    }

                    this.entryForm.studentList.innerHTML = students.map((student, index) => `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center border-t pt-4">
                            <div class="md:col-span-1 font-medium text-gray-700">${student}</div>
                            <div class="md:col-span-2">
                                <div class="flex flex-wrap items-center gap-4">
                                    <div class="flex items-center">
                                        <input id="present-${index}" name="status-${student.replace(/\s+/g, '-')}" type="radio" value="present" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                                        <label for="present-${index}" class="ml-2 block text-sm text-gray-900">Hadir</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="absent-${index}" name="status-${student.replace(/\s+/g, '-')}" type="radio" value="absent" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                        <label for="absent-${index}" class="ml-2 block text-sm text-gray-900">Tidak Hadir</label>
                                    </div>
                                     <div class="flex-grow">
                                        <input type="text" placeholder="Sebab (jika tidak hadir)" data-student="${student}" class="remarks-input w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    this.entryForm.studentList.querySelectorAll('input[type="radio"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            const remarksInput = e.target.closest('.flex-wrap').querySelector('.remarks-input');
                            remarksInput.disabled = e.target.value !== 'absent';
                            if (e.target.value !== 'absent') remarksInput.value = '';
                        });
                    });
                },

                renderDashboard() {
                    const selectedClass = this.dashboardView.classSelect.value;
                    const selectedClassType = this.dashboardView.classTypeSelect.value;
                    const selectedMonth = this.dashboardView.monthSelect.value;
                    const students = this.classRosters[selectedClass] || [];
                    let classData = this.attendanceData[selectedClass]?.[selectedClassType] || [];
                    
                    if (selectedMonth && selectedMonth !== 'all') {
                        classData = classData.filter(record => record.date.startsWith(selectedMonth));
                    }

                    const attendanceTakingSessions = classData.filter(record => record.type !== 'session_remark');

                    if (students.length === 0) {
                        this.dashboardView.body.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Tiada pelajar untuk kelas ini.</td></tr>`;
                        return;
                    }
                    if (attendanceTakingSessions.length === 0) {
                        this.dashboardView.body.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Tiada data kehadiran (kelas berlangsung) direkodkan bagi penapis yang dipilih.</td></tr>`;
                        return;
                    }

                    const summary = students.map(student => {
                        let presentCount = 0, absentCount = 0;
                        const remarks = [];
                        attendanceTakingSessions.forEach(record => {
                            const studentRecord = record.records[student];
                            if (studentRecord) {
                                if (studentRecord.status === 'present') presentCount++;
                                if (studentRecord.status === 'absent') {
                                    absentCount++;
                                    if (studentRecord.remarks) remarks.push({ date: record.date, remark: studentRecord.remarks });
                                }
                            }
                        });
                        const totalRecords = presentCount + absentCount;
                        const percentage = totalRecords > 0 ? ((presentCount / totalRecords) * 100).toFixed(1) : 0;
                        return { name: student, percentage, absentCount, remarks };
                    });

                    this.dashboardView.body.innerHTML = summary.map(s => {
                        const percentageColor = s.percentage >= 80 ? 'bg-green-500' : s.percentage >= 50 ? 'bg-yellow-500' : 'bg-red-500';
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${s.name}</div></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${percentageColor} h-2.5 rounded-full" style="width: ${s.percentage}%"></div></div>
                                        <span class="ml-3 text-sm font-medium text-gray-600">${s.percentage}%</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${s.absentCount > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${s.absentCount}</span></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center"><button ${s.absentCount === 0 ? 'disabled' : ''} data-student-name="${s.name}" class="view-remarks-btn text-blue-600 hover:text-blue-900 disabled:text-gray-400 disabled:cursor-not-allowed">Papar Sebab</button></td>
                            </tr>
                        `;
                    }).join('');
                    
                    this.dashboardView.body.querySelectorAll('.view-remarks-btn').forEach(btn => {
                        btn.addEventListener('click', e => {
                            const studentName = e.target.getAttribute('data-student-name');
                            const studentSummary = summary.find(s => s.name === studentName);
                            if (studentSummary) this.showRemarksModal(studentSummary);
                        });
                    });
                },

                renderSummary() {
                    const selectedMonth = this.summaryView.monthSelect.value;
                    const classNames = Object.keys(this.classRosters);
                    if (classNames.length === 0) {
                        this.summaryView.body.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Tiada data kelas untuk dipaparkan.</td></tr>`;
                        return;
                    }

                    const summaryHtml = classNames.map(className => {
                        const students = this.classRosters[className] || [];
                        if (students.length === 0) return '';

                        let totalSessions = 0;
                        let totalPresentOverall = 0;
                        let totalPossibleAttendancesFiltered = 0;
                        const studentStats = {};
                        students.forEach(s => { studentStats[s] = { present: 0, total: 0 }; });

                        this.classTypes.forEach(classType => {
                            let records = this.attendanceData[className]?.[classType] || [];
                            if (selectedMonth && selectedMonth !== 'all') {
                                records = records.filter(record => record.date.startsWith(selectedMonth));
                            }
                            
                            const attendanceTakingRecords = records.filter(r => r.type !== 'session_remark');
                            totalSessions += attendanceTakingRecords.length;
                            
                            attendanceTakingRecords.forEach(record => {
                                students.forEach(student => {
                                    const studentRecord = record.records[student];
                                    if (studentRecord) {
                                        studentStats[student].total++;
                                        if (studentRecord.status === 'present') {
                                            studentStats[student].present++;
                                            totalPresentOverall++;
                                        }
                                    }
                                });
                            });
                        });
                        
                        students.forEach(student => {
                           totalPossibleAttendancesFiltered += studentStats[student].total;
                        });

                        const overallPercentage = totalPossibleAttendancesFiltered > 0 ? ((totalPresentOverall / totalPossibleAttendancesFiltered) * 100).toFixed(1) : 0;
                        
                        let highest = { name: '-', percentage: -1 };
                        let lowest = { name: '-', percentage: 101 };

                        students.forEach(student => {
                            const stats = studentStats[student];
                            const percentage = stats.total > 0 ? (stats.present / stats.total) * 100 : 0;
                            if (stats.total > 0) {
                                if (percentage > highest.percentage) {
                                    highest = { name: student, percentage: percentage.toFixed(1) };
                                }
                                if (percentage < lowest.percentage) {
                                    lowest = { name: student, percentage: percentage.toFixed(1) };
                                }
                            }
                        });

                        if (highest.name === '-') highest.percentage = 0;
                        if (lowest.name === '-') lowest.percentage = 0;
                        if (totalSessions === 0) {
                            lowest.name = '-';
                            lowest.percentage = 0;
                        }

                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${className}</div></td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                                    <button data-class-name="${className}" class="view-sessions-btn text-blue-600 hover:text-blue-900 underline disabled:text-gray-400 disabled:cursor-not-allowed disabled:no-underline" ${totalSessions === 0 ? 'disabled' : ''}>
                                        ${totalSessions}
                                    </button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-700">${overallPercentage}%</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${highest.name} <span class="text-green-600 font-semibold">(${highest.percentage}%)</span></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lowest.name} <span class="text-red-600 font-semibold">(${lowest.percentage}%)</span></td>
                            </tr>
                        `;
                    }).join('');

                    this.summaryView.body.innerHTML = summaryHtml || `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Tiada data kehadiran direkodkan lagi.</td></tr>`;
                    
                    this.summaryView.body.querySelectorAll('.view-sessions-btn').forEach(btn => {
                        btn.addEventListener('click', e => {
                            const className = e.target.getAttribute('data-class-name');
                            this.showSessionsModal(className);
                        });
                    });
                },

                // --- CORE LOGIC ---
                switchTab(tabName) {
                    Object.values(this.content).forEach(c => c.classList.add('hidden'));
                    Object.values(this.tabs).forEach(t => t.classList.remove('tab-active'));

                    this.content[tabName].classList.remove('hidden');
                    this.tabs[tabName].classList.add('tab-active');
                    
                    if (tabName === 'dashboard') this.renderDashboard();
                    if (tabName === 'summary') this.renderSummary();
                },
                
                toggleSessionRemark() {
                    const isChecked = this.entryForm.sessionRemarkToggle.checked;
                    this.entryForm.sessionRemarkContainer.classList.toggle('hidden', !isChecked);
                    this.entryForm.studentListHeader.classList.toggle('hidden', isChecked);
                    this.entryForm.studentList.classList.toggle('hidden', isChecked);
                    this.entryForm.submitBtn.textContent = isChecked ? 'Simpan Catatan Sesi' : 'Catat Kehadiran';
                },

                setInitialDateTime() {
                    const now = new Date();
                    this.entryForm.date.value = now.toISOString().split('T')[0];
                    this.entryForm.time.value = now.toTimeString().split(' ')[0].substring(0, 5);
                },

                submitAttendance() {
                    const className = this.entryForm.class.value;
                    const classType = this.entryForm.classType.value;
                    const date = this.entryForm.date.value;
                    const time = this.entryForm.time.value;
                    
                    if (!date || !time) { this.showAlert('Sila pilih tarikh dan masa.', 'error'); return; }

                    if (!this.attendanceData[className]) this.attendanceData[className] = {};
                    if (!this.attendanceData[className][classType]) this.attendanceData[className][classType] = [];

                    const existingRecord = this.attendanceData[className][classType].find(r => r.date === date);
                    if (existingRecord) {
                        this.showAlert(`Rekod untuk ${className} (${classType}) pada ${date} telah wujud.`, 'error');
                        return;
                    }

                    if (this.entryForm.sessionRemarkToggle.checked) {
                        const remark = this.entryForm.sessionRemarkInput.value.trim();
                        if (!remark) { this.showAlert('Sila masukkan sebab atau catatan.', 'error'); return; }
                        
                        const newRecord = { date, time, type: 'session_remark', remark };
                        this.attendanceData[className][classType].push(newRecord);
                        this.saveData();
                        this.showAlert('Catatan sesi berjaya disimpan!', 'success');
                        
                        this.entryForm.sessionRemarkToggle.checked = false;
                        this.toggleSessionRemark();
                        this.entryForm.sessionRemarkInput.value = '';
                    } else {
                        const students = this.classRosters[className] || [];
                        if (students.length === 0) { this.showAlert('Tiada pelajar dalam kelas ini.', 'error'); return; }

                        const newRecord = { date, time, records: {} };
                        const studentRows = this.entryForm.studentList.querySelectorAll('.grid');
                        studentRows.forEach((row, index) => {
                            const studentName = students[index];
                            const status = row.querySelector(`input[name="status-${studentName.replace(/\s+/g, '-')}"]:checked`).value;
                            const remarks = row.querySelector('.remarks-input').value.trim();
                            newRecord.records[studentName] = { status, remarks: status === 'absent' ? remarks : '' };
                        });

                        this.attendanceData[className][classType].push(newRecord);
                        this.saveData();
                        this.showAlert('Kehadiran berjaya direkodkan!', 'success');
                    }
                    this.render();
                },

                showRemarksModal(studentSummary) {
                    this.modal.studentName.textContent = `Sebab Tidak Hadir untuk ${studentSummary.name}`;
                    if(studentSummary.remarks.length > 0) {
                       this.modal.content.innerHTML = studentSummary.remarks.map(r => `
                            <div class="border-l-4 border-blue-500 pl-3 py-1 my-1">
                                <p class="font-semibold">${new Date(r.date + 'T00:00:00').toDateString()}</p>
                                <p>${r.remark || 'Tiada sebab diberikan.'}</p>
                            </div>
                        `).join('');
                    } else {
                        this.modal.content.innerHTML = '<p>Tiada sebab direkodkan.</p>';
                    }
                    this.modal.container.classList.remove('hidden');
                },

                closeModal() {
                    this.modal.container.classList.add('hidden');
                },

                showSessionsModal(className) {
                    const selectedMonth = this.summaryView.monthSelect.value;
                    this.sessionsModal.title.textContent = `Senarai Sesi untuk Kelas ${className}`;
                    
                    const sessions = [];
                    this.classTypes.forEach(classType => {
                        let records = this.attendanceData[className]?.[classType] || [];
                        if (selectedMonth && selectedMonth !== 'all') {
                            records = records.filter(record => record.date.startsWith(selectedMonth));
                        }
                        records.forEach(record => {
                             if (record.type === 'session_remark') {
                                sessions.push({ date: record.date, time: record.time, type: classType, isRemark: true, remark: record.remark });
                            } else {
                                sessions.push({ date: record.date, time: record.time, type: classType, isRemark: false });
                            }
                        });
                    });
                    
                    sessions.sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));

                    if (sessions.length > 0) {
                        this.sessionsModal.content.innerHTML = `
                            <ul class="list-disc pl-5 space-y-2">
                                ${sessions.map(s => {
                                    const displayInfo = s.isRemark
                                        ? `<span class="font-semibold text-indigo-600">${s.remark}</span>`
                                        : `${s.time} (${s.type})`;
                                    return `
                                    <li>
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="font-semibold">${new Date(s.date + 'T00:00:00').toDateString()}</span>
                                                - ${displayInfo}
                                            </div>
                                            <button data-class-name="${className}" data-date="${s.date}" data-type="${s.type}" class="delete-session-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                            </button>
                                        </div>
                                    </li>
                                `}).join('')}
                            </ul>`;
                    } else {
                        this.sessionsModal.content.innerHTML = '<p>Tiada sesi direkodkan untuk kelas ini.</p>';
                    }

                    this.sessionsModal.content.querySelectorAll('.delete-session-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => this.promptDeleteSession(e.currentTarget.dataset));
                    });

                    this.sessionsModal.container.classList.remove('hidden');
                },

                closeSessionsModal() {
                    this.sessionsModal.container.classList.add('hidden');
                },

                promptDeleteSession({ className, date, type }) {
                    this.deleteConfirmModal.message.textContent = `Adakah anda pasti mahu memadam rekod untuk kelas ${className} (${type}) pada ${date}? Tindakan ini tidak boleh diubah.`;
                    this.deleteConfirmModal.confirmBtn.dataset.className = className;
                    this.deleteConfirmModal.confirmBtn.dataset.date = date;
                    this.deleteConfirmModal.confirmBtn.dataset.type = type;
                    this.deleteConfirmModal.container.classList.remove('hidden');
                },

                closeDeleteConfirmModal() {
                    this.deleteConfirmModal.container.classList.add('hidden');
                },

                executeDeleteSession(e) {
                    const { className, date, type } = e.currentTarget.dataset;
                    const records = this.attendanceData[className]?.[type];

                    if (records) {
                        const recordIndex = records.findIndex(r => r.date === date);
                        if (recordIndex > -1) {
                            records.splice(recordIndex, 1);
                            this.saveData();
                            this.showAlert('Rekod berjaya dipadam.', 'success');
                        }
                    }

                    this.closeDeleteConfirmModal();
                    this.closeSessionsModal();
                    this.render(); // Re-render the whole UI
                },
                
                showAlert(message, type = 'success') {
                    this.alert.message.textContent = message;
                    this.alert.container.classList.remove('bg-green-500', 'bg-red-500');
                    if (type === 'error') this.alert.container.classList.add('bg-red-500');
                    else this.alert.container.classList.add('bg-green-500');
                    this.alert.container.classList.remove('hidden', 'translate-x-full');
                    this.alert.container.classList.add('translate-x-0');
                    setTimeout(() => {
                        this.alert.container.classList.remove('translate-x-0');
                        this.alert.container.classList.add('translate-x-full');
                        setTimeout(() => this.alert.container.classList.add('hidden'), 300);
                    }, 3000);
                }
            };

            app.init();
        });
    </script>
</body>
</html>

